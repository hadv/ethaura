# EthAura Architecture Diagrams

This document contains visual diagrams to help understand the EthAura system.

## System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         User Interface                          │
│                    (React Frontend + WebAuthn)                  │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Bundler (ERC-4337)                         │
│                  (Collects & Submits UserOps)                   │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    EntryPoint Contract                          │
│                  (Validates & Executes UserOps)                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                     P256Account Contract                        │
│              (Validates P-256 Signatures via EIP-7951)          │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                  P256VERIFY Precompile (0x0100)                 │
│                   (Native P-256 Verification)                   │
└─────────────────────────────────────────────────────────────────┘
```

## Account Creation Flow

```
┌──────────┐
│   User   │
└────┬─────┘
     │ 1. Create Passkey
     ▼
┌──────────────────┐
│  WebAuthn API    │
│ (Browser/Device) │
└────┬─────────────┘
     │ 2. Generate P-256 Key Pair
     │    (Private key in Secure Enclave)
     ▼
┌──────────────────┐
│    Frontend      │
│ Extract (qx, qy) │
└────┬─────────────┘
     │ 3. Call createAccount(qx, qy, owner, salt)
     ▼
┌──────────────────────┐
│ P256AccountFactory   │
│ Deploy with CREATE2  │
└────┬─────────────────┘
     │ 4. Deploy & Initialize
     ▼
┌──────────────────┐
│  P256Account     │
│ Store (qx, qy)   │
└──────────────────┘
```

## Transaction Signing Flow

```
┌──────────┐
│   User   │
└────┬─────┘
     │ 1. Create Transaction
     ▼
┌──────────────────┐
│    Frontend      │
│ Build UserOp     │
└────┬─────────────┘
     │ 2. Compute userOpHash
     ▼
┌──────────────────┐
│  WebAuthn API    │
│ Sign with Passkey│
└────┬─────────────┘
     │ 3. Return DER Signature
     ▼
┌──────────────────┐
│    Frontend      │
│ Decode DER → r,s │
└────┬─────────────┘
     │ 4. Submit UserOp with signature
     ▼
┌──────────────────┐
│     Bundler      │
│ Collect UserOps  │
└────┬─────────────┘
     │ 5. Call handleOps()
     ▼
┌──────────────────┐
│   EntryPoint     │
│ Validate & Execute│
└────┬─────────────┘
     │ 6. Call validateUserOp()
     ▼
┌──────────────────┐
│  P256Account     │
│ Verify Signature │
└────┬─────────────┘
     │ 7. Call P256.verify()
     ▼
┌──────────────────┐
│ P256VERIFY (0x0100)│
│ Native Verification│
└────┬─────────────┘
     │ 8. Return valid/invalid
     ▼
┌──────────────────┐
│   EntryPoint     │
│ Execute Transaction│
└──────────────────┘
```

## Signature Verification Process

```
┌─────────────────────────────────────────────────────────────┐
│                    UserOperation                            │
│  { sender, nonce, callData, signature, ... }                │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Compute userOpHash                             │
│  hash = keccak256(userOp, entryPoint, chainId)              │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Compute messageHash                            │
│  messageHash = SHA256(userOpHash)                           │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Extract signature (r, s)                       │
│  signature = r (32 bytes) || s (32 bytes)                   │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Check malleability                             │
│  require(s <= N/2)                                          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Call precompile                                │
│  staticcall(0x0100, messageHash || r || s || qx || qy)      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│              Return result                                  │
│  true if valid, false otherwise                             │
└─────────────────────────────────────────────────────────────┘
```

## Component Interaction

```
┌─────────────────────────────────────────────────────────────────┐
│                         Frontend Layer                          │
├─────────────────────────────────────────────────────────────────┤
│  PasskeyManager  │  AccountManager  │  TransactionSender       │
│  - Create key    │  - Deploy account│  - Sign transaction      │
│  - Extract pubkey│  - Predict addr  │  - Submit UserOp         │
└────────┬─────────┴──────────┬───────┴──────────┬───────────────┘
         │                    │                  │
         │                    │                  │
┌────────▼────────────────────▼──────────────────▼───────────────┐
│                      Smart Contract Layer                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐         ┌──────────────────┐             │
│  │ P256AccountFactory│────────▶│  P256Account     │             │
│  │ - createAccount  │         │  - validateUserOp│             │
│  │ - getAddress     │         │  - execute       │             │
│  └──────────────────┘         └────────┬─────────┘             │
│                                        │                        │
│                                        ▼                        │
│                              ┌──────────────────┐               │
│                              │  P256 Library    │               │
│                              │  - verify        │               │
│                              └────────┬─────────┘               │
│                                       │                         │
└───────────────────────────────────────┼─────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Precompile Layer                           │
├─────────────────────────────────────────────────────────────────┤
│                   P256VERIFY (0x0100)                           │
│                   - Native P-256 verification                   │
│                   - ~6,900 gas                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
┌──────────────┐
│ User Action  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────────┐
│ Frontend                                                 │
│ ┌──────────┐    ┌──────────┐    ┌──────────────┐        │
│ │ Passkey  │───▶│ UserOp   │───▶│ Signature    │        │
│ │ Creation │    │ Building │    │ (DER → r,s)  │        │
│ └──────────┘    └──────────┘    └──────┬───────┘        │
└────────────────────────────────────────┼────────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────┐
│ Bundler                                                 │
│ ┌──────────┐    ┌──────────┐    ┌──────────────┐       │
│ │ Collect  │───▶│ Validate │───▶│ Submit to    │       │
│ │ UserOps  │    │ UserOps  │    │ EntryPoint   │       │
│ └──────────┘    └──────────┘    └──────┬───────┘       │
└────────────────────────────────────────┼───────────────┘
                                         │
                                         ▼
┌─────────────────────────────────────────────────────────┐
│ EntryPoint                                              │
│ ┌──────────┐    ┌──────────┐    ┌──────────────┐       │
│ │ Validate │───▶│ Execute  │───▶│ Emit Events  │       │
│ │ UserOp   │    │ Calls    │    │              │       │
│ └────┬─────┘    └──────────┘    └──────────────┘       │
└─────┼───────────────────────────────────────────────────┘
      │
      ▼
┌─────────────────────────────────────────────────────────┐
│ P256Account                                             │
│ ┌──────────┐    ┌──────────┐    ┌──────────────┐       │
│ │ Verify   │───▶│ Check    │───▶│ Return       │       │
│ │ Signature│    │ via 0x100│    │ Result       │       │
│ └──────────┘    └──────────┘    └──────────────┘       │
└─────────────────────────────────────────────────────────┘
```

## Security Layers

```
┌─────────────────────────────────────────────────────────┐
│ Layer 1: Device Security                                │
│ - Secure Enclave / TPM                                  │
│ - Biometric authentication                              │
│ - Private key never leaves device                       │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 2: WebAuthn Protocol                              │
│ - Challenge-response                                    │
│ - Origin validation                                     │
│ - User presence verification                            │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 3: Smart Contract                                 │
│ - Signature verification                                │
│ - Malleability protection                               │
│ - Access control                                        │
└────────────────────────┬────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│ Layer 4: ERC-4337                                       │
│ - Nonce management                                      │
│ - Gas abstraction                                       │
│ - Replay protection                                     │
└─────────────────────────────────────────────────────────┘
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────┐
│                    Sepolia Testnet                      │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │ EntryPoint v0.7                                  │  │
│  │ 0x0000000071727De22E5E9d8BAf0edAc6f37da032       │  │
│  └──────────────────────────────────────────────────┘  │
│                         │                               │
│                         ▼                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │ P256AccountFactory (deployed by you)             │  │
│  │ 0x...                                            │  │
│  └──────────────────────────────────────────────────┘  │
│                         │                               │
│                         ▼                               │
│  ┌──────────────────────────────────────────────────┐  │
│  │ P256Account instances (created via factory)      │  │
│  │ 0x... (deterministic addresses)                  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │ P256VERIFY Precompile                            │  │
│  │ 0x0100 (native to network)                       │  │
│  └──────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

These diagrams provide a visual understanding of how EthAura works. For more details, see [ARCHITECTURE.md](../ARCHITECTURE.md).

